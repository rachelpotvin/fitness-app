<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>CheckIt — simple goals</title>
  <!-- Supabase CDN -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root{
      --bg:#0b0f14; --card:#121923; --muted:#2a3544; --text:#e8eef7; --accent:#6ee7b7; --accent2:#60a5fa; --warn:#f59e0b; --danger:#ef4444;
    }
    html,body{height:100%;}
    body{margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial; background:linear-gradient(180deg,#0b0f14,#0f1722 30%,#0b0f14); color:var(--text);}    
    .container{max-width:960px; margin:0 auto; padding:16px;}
    header{display:flex; gap:12px; align-items:center; justify-content:space-between;}
    .title{display:flex; align-items:center; gap:10px;}
    .badge{background:var(--muted); color:#cfe7ff; padding:4px 10px; border-radius:999px; font-size:12px; letter-spacing:.3px;}
    .row{display:flex; gap:12px; flex-wrap:wrap;}
    .card{background:var(--card); border:1px solid #1f2a37; border-radius:16px; padding:14px; box-shadow:0 10px 30px rgba(0,0,0,.25);}    
    .card h3{margin:0 0 8px 0; font-size:16px; font-weight:600}
    .card small{color:#a9b9d6}
    .grid{display:grid; grid-template-columns: repeat(12, minmax(0, 1fr)); gap:12px}
    .col-4{grid-column: span 4}
    .col-8{grid-column: span 8}
    .col-12{grid-column: span 12}
    @media (max-width:800px){.grid{grid-template-columns: repeat(6, 1fr)} .col-8{grid-column: span 6} .col-4{grid-column: span 6}}
    @media (max-width:540px){.grid{grid-template-columns: repeat(4, 1fr)} .col-8{grid-column: span 4} .col-4{grid-column: span 4}}
    .btn{background:#1f2937; border:1px solid #2c3b52; color:#cfe7ff; padding:10px 12px; border-radius:12px; cursor:pointer; font-weight:600}
    .btn:hover{background:#253244}
    .btn.primary{background:linear-gradient(180deg, #1a2a2a, #12261e); border-color:#204a3a}
    .btn.primary:hover{background:linear-gradient(180deg,#18322a,#123025)}
    .btn.warn{background:#33260f; border-color:#5a400a; color:#ffd089}
    .btn.danger{background:#3a1313; border-color:#5a1e1e; color:#ffd3d3}
    .controls{display:flex; gap:8px; flex-wrap:wrap}
    .input{background:#0c1320; border:1px solid #1f2a37; color:var(--text); padding:10px 12px; border-radius:12px; outline:none;}
    .input:focus{border-color:#365986; box-shadow:0 0 0 3px rgba(96,165,250,.15)}
    .goal-list{display:flex; flex-direction:column; gap:8px; margin-top:8px}
    .goal{display:flex; justify-content:space-between; align-items:center; gap:8px; background:#0d1422; border:1px solid #1f2a37; padding:10px; border-radius:12px}
    .goal .left{display:flex; align-items:center; gap:10px}
    .pill{font-size:12px; padding:2px 8px; border-radius:999px; background:#172033; color:#b9d6ff; border:1px solid #22304a}
    .checkbox{appearance:none; width:22px; height:22px; border-radius:7px; border:1px solid #2a3a55; display:grid; place-items:center; cursor:pointer; background:#0c1320}
    .checkbox:checked{background:conic-gradient(from 180deg at 50% 50%, #0c1320, #0c1320) padding-box, linear-gradient(180deg, #76f2c1, #7cc2ff) border-box; border-color:transparent}
    .checkbox:checked::after{content:"✓"; font-weight:800;}
    .progress{height:10px; background:#0b111b; border:1px solid #1f2a37; border-radius:999px; overflow:hidden}
    .progress>span{display:block; height:100%; background:linear-gradient(90deg, var(--accent), var(--accent2)); width:0%}
    .calendar{display:grid; grid-template-columns: repeat(7, 1fr); gap:6px; margin-top:8px}
    .day{background:#0d1422; border:1px solid #1f2a37; border-radius:10px; padding:8px; min-height:64px; display:flex; flex-direction:column; gap:6px}
    .day .d{font-size:12px; color:#a9b9d6}
    .tag{font-size:11px; background:#132033; color:#9ac3ff; padding:2px 6px; border-radius:999px; align-self:flex-start; border:1px solid #1e3456}
    .today{outline:2px solid #375a86}
    .empty{opacity:.35}
    .sp{height:1px; background:#1f2a37; margin:14px 0}
    
    /* Auth styles */
    .auth-container{display:flex; justify-content:center; align-items:center; min-height:100vh; padding:20px}
    .auth-card{background:var(--card); border:1px solid #1f2a37; border-radius:16px; padding:24px; max-width:400px; width:100%}
    .auth-card h2{margin:0 0 16px 0; text-align:center}
    .auth-form{display:flex; flex-direction:column; gap:12px}
    .auth-form .btn{width:100%}
    .loading{opacity:0.7; pointer-events:none}
    .sync-status{position:fixed; top:16px; right:16px; background:var(--card); border:1px solid #1f2a37; border-radius:8px; padding:8px 12px; font-size:12px; z-index:1000}
  </style>
</head>
<body>
  <!-- Auth Container -->
  <div id="authContainer" class="auth-container" style="display:none">
    <div class="auth-card">
      <h2>CheckIt</h2>
      <div class="auth-form">
        <input id="emailInput" class="input" type="email" placeholder="Email" />
        <input id="passwordInput" class="input" type="password" placeholder="Password" />
        <button class="btn primary" id="signInBtn">Sign In</button>
        <button class="btn" id="signUpBtn">Create Account</button>
      </div>
    </div>
  </div>

  <!-- Main App -->
  <div id="appContainer">
    <div class="sync-status" id="syncStatus">Syncing...</div>
    
    <div class="container">
      <header>
        <div class="title">
          <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg"><path d="M20 7L9 18l-5-5" stroke="#6ee7b7" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
          <h1 style="margin:0;font-size:20px">CheckIt</h1>
          <span class="badge">cloud • private • free</span>
        </div>
        <div class="controls">
          <button class="btn" id="btnExport">Export</button>
          <label class="btn" for="importFile">Import</label>
          <input id="importFile" type="file" accept="application/json" style="display:none" />
          <button class="btn" id="btnSignOut">Sign Out</button>
          <button class="btn danger" id="btnClear">Reset</button>
        </div>
      </header>

      <div class="sp"></div>

      <div class="grid">
        <section class="card col-8">
          <h3>Today</h3>
          <small id="todayLabel"></small>
          <div id="todayGoals" class="goal-list"></div>
          <div style="display:flex; align-items:center; gap:10px; margin-top:6px">
            <div class="progress" style="flex:1"><span id="todayProgress"></span></div>
            <small id="todayStats"></small>
          </div>
        </section>

        <section class="card col-4">
          <h3>Targets</h3>
          <small>Weekly and monthly points</small>
          <div style="margin-top:10px; display:flex; flex-direction:column; gap:10px">
            <label>Weekly target points <input id="weeklyTarget" class="input" type="number" min="0" placeholder="e.g., 20"/></label>
            <label>Monthly target points <input id="monthlyTarget" class="input" type="number" min="0" placeholder="e.g., 80"/></label>
            <button class="btn" id="btnSaveTargets">Save targets</button>
          </div>
          <div class="sp"></div>
          <div>
            <small>Progress this week</small>
            <div class="progress"><span id="weekProgress"></span></div>
            <small id="weekStats"></small>
          </div>
          <div style="height:8px"></div>
          <div>
            <small>Progress this month</small>
            <div class="progress"><span id="monthProgress"></span></div>
            <small id="monthStats"></small>
          </div>
        </section>

        <section class="card col-12">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap">
            <h3 style="margin:0">Calendar</h3>
            <div class="controls">
              <button class="btn" id="prevMonth">◀</button>
              <div id="monthLabel" class="badge"></div>
              <button class="btn" id="nextMonth">▶</button>
            </div>
          </div>
          <div class="calendar" id="calendar"></div>
        </section>

        <section class="card col-12">
          <h3>Goals</h3>
          <div class="controls" id="addGoalControls" style="margin-bottom:8px">
            <select id="goalMode" class="input">
              <option value="binary">Binary</option>
              <option value="count">Count</option>
            </select>
            <input id="goalName" class="input" placeholder="e.g., Walk steps"/>
            <input id="goalPoints" class="input" type="number" min="1" value="1" style="width:110px"/>
            <input id="goalUnitLabel" class="input" placeholder="Unit label (e.g., 5k steps)" style="width:200px; display:none"/>
            <input id="goalUnitSize" class="input" type="number" min="1" value="1" style="width:120px; display:none"/>
            <button class="btn primary" id="btnAddGoal">Add goal</button>
          </div>
          <small>Tip: For steps, choose Mode = Count, Unit label = "5k steps", Unit size = 5000, Points = 1.</small>
          <div id="goalList" class="goal-list"></div>
        </section>
      </div>

      <footer style="opacity:.7; margin:18px 6px 6px 6px; text-align:center; font-size:12px">
        Built with Supabase. Your data is synced across all devices.
      </footer>
    </div>
  </div>

<script>
  // ------------------ Supabase Setup ------------------
  // Replace these with your actual Supabase credentials
  const SUPABASE_URL = 'https://ipvpgyihcgkgdahjbrtu.supabase.co'; // Replace with your actual URL
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImlwdnBneWloY2drZ2RhaGpicnR1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY1ODkxNTMsImV4cCI6MjA3MjE2NTE1M30.0QtB9_7chU9eAFYmN3At4-4w76W4eA6UNMVYDyYLRCU'; // Replace with your actual anon key
  
  const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  
  // ------------------ Auth Management ------------------
  let currentUser = null;
  
  async function initAuth() {
    try {
      console.log('Initializing auth...');
      const { data: { user }, error } = await supabaseClient.auth.getUser();
      
      if (error) {
        console.error('Auth error:', error);
        showAuth();
        return;
      }
      
      if (user) {
        console.log('User found:', user.email);
        currentUser = user;
        showApp();
        loadData();
      } else {
        console.log('No user found, showing auth');
        showAuth();
      }
      
      // Listen for auth changes
      supabaseClient.auth.onAuthStateChange((event, session) => {
        console.log('Auth state change:', event, session?.user?.email);
        if (event === 'SIGNED_IN' && session?.user) {
          currentUser = session.user;
          showApp();
          loadData();
        } else if (event === 'SIGNED_OUT') {
          currentUser = null;
          showAuth();
        }
      });
    } catch (error) {
      console.error('Init auth error:', error);
      showAuth();
    }
  }
  
  function showAuth() {
    document.getElementById('authContainer').style.display = 'flex';
    document.getElementById('appContainer').style.display = 'none';
  }
  
  function showApp() {
    document.getElementById('authContainer').style.display = 'none';
    document.getElementById('appContainer').style.display = 'block';
  }
  
  async function signIn() {
    const email = document.getElementById('emailInput').value;
    const password = document.getElementById('passwordInput').value;
    
    const { error } = await supabaseClient.auth.signInWithPassword({
      email,
      password
    });
    
    if (error) {
      alert('Sign in failed: ' + error.message);
    }
  }
  
  async function signUp() {
    const email = document.getElementById('emailInput').value;
    const password = document.getElementById('passwordInput').value;
    
    const { error } = await supabaseClient.auth.signUp({
      email,
      password
    });
    
    if (error) {
      alert('Sign up failed: ' + error.message);
    } else {
      alert('Check your email for confirmation link!');
    }
  }
  
  async function signOut() {
    await supabaseClient.auth.signOut();
  }
  
  // ------------------ Data Management ------------------
  const defaultState = {
    goals: [
      {id: id(), name: 'Walk steps', points: 1, mode:'count', unitLabel:'5k steps', unitSize: 5000},
      {id: id(), name: 'Drink 2L water', points: 1, mode:'binary'}
    ],
    checks: {},
    weeklyTarget: 20,
    monthlyTarget: 80
  };
  
  let state = { ...defaultState };
  let isInitialized = false;
  
  async function loadData() {
    if (!currentUser) return;
    
    try {
      updateSyncStatus('Loading data...');
      console.log('Loading data for user:', currentUser.id);
      
      // Load goals
      const { data: goals, error: goalsError } = await supabaseClient
        .from('goals')
        .select('*')
        .eq('user_id', currentUser.id)
        .order('created_at');
      
      if (goalsError) {
        console.error('Goals error:', goalsError);
        throw goalsError;
      }
      console.log('Goals loaded:', goals);
      
      // Load checks
      const { data: checks, error: checksError } = await supabaseClient
        .from('daily_checks')
        .select('*')
        .eq('user_id', currentUser.id);
      
      if (checksError) {
        console.error('Checks error:', checksError);
        throw checksError;
      }
      console.log('Checks loaded:', checks);
      
      // Load targets
      const { data: targets, error: targetsError } = await supabaseClient
        .from('user_targets')
        .select('*')
        .eq('user_id', currentUser.id)
        .single();
      
      if (targetsError && targetsError.code !== 'PGRST116') {
        console.error('Targets error:', targetsError);
        throw targetsError;
      }
      console.log('Targets loaded:', targets);
      
      // Transform data
      const checksMap = {};
      checks?.forEach(check => {
        if (!checksMap[check.date]) checksMap[check.date] = {};
        checksMap[check.date][check.goal_id] = check.value;
      });
      
      state = {
        goals: goals || defaultState.goals,
        checks: checksMap,
        weeklyTarget: targets?.weekly_target || defaultState.weeklyTarget,
        monthlyTarget: targets?.monthly_target || defaultState.monthlyTarget
      };
      
      isInitialized = true;
      render();
      updateSyncStatus('Synced');
      console.log('Data loaded successfully');
      
    } catch (error) {
      console.error('Error loading data:', error);
      updateSyncStatus('Error: ' + error.message);
      
      // If tables don't exist, show a helpful message
      if (error.message.includes('relation') && error.message.includes('does not exist')) {
        alert('Database tables not found. Please run the SQL schema in Supabase SQL Editor first.');
      }
    }
  }
  
  async function saveGoals() {
    if (!currentUser || !isInitialized) return;
    
    try {
      updateSyncStatus('Saving goals...');
      
      // Delete existing goals
      await supabaseClient
        .from('goals')
        .delete()
        .eq('user_id', currentUser.id);
      
      // Insert new goals
      if (state.goals.length > 0) {
        const goalsToInsert = state.goals.map(goal => ({
          user_id: currentUser.id,
          goal_id: goal.id,
          name: goal.name,
          points: goal.points,
          mode: goal.mode,
          unit_label: goal.unitLabel || '',
          unit_size: goal.unitSize || 1
        }));
        
        const { error } = await supabaseClient
          .from('goals')
          .insert(goalsToInsert);
        
        if (error) throw error;
      }
      
      updateSyncStatus('Goals saved');
    } catch (error) {
      console.error('Error saving goals:', error);
      updateSyncStatus('Error saving goals');
    }
  }
  
  async function saveChecks() {
    if (!currentUser || !isInitialized) return;
    
    try {
      updateSyncStatus('Saving checks...');
      
      // Prepare checks for insertion
      const checksToInsert = [];
      Object.entries(state.checks).forEach(([date, dayChecks]) => {
        Object.entries(dayChecks).forEach(([goalId, value]) => {
          checksToInsert.push({
            user_id: currentUser.id,
            date: date,
            goal_id: goalId,
            value: value
          });
        });
      });
      
      // Delete existing checks
      await supabaseClient
        .from('daily_checks')
        .delete()
        .eq('user_id', currentUser.id);
      
      // Insert new checks
      if (checksToInsert.length > 0) {
        const { error } = await supabaseClient
          .from('daily_checks')
          .insert(checksToInsert);
        
        if (error) throw error;
      }
      
      updateSyncStatus('Checks saved');
    } catch (error) {
      console.error('Error saving checks:', error);
      updateSyncStatus('Error saving checks');
    }
  }
  
  async function saveTargets() {
    if (!currentUser || !isInitialized) return;
    
    try {
      updateSyncStatus('Saving targets...');
      
      const { error } = await supabaseClient
        .from('user_targets')
        .upsert({
          user_id: currentUser.id,
          weekly_target: state.weeklyTarget,
          monthly_target: state.monthlyTarget
        });
      
      if (error) throw error;
      
      updateSyncStatus('Targets saved');
    } catch (error) {
      console.error('Error saving targets:', error);
      updateSyncStatus('Error saving targets');
    }
  }
  
  function updateSyncStatus(message) {
    const statusEl = document.getElementById('syncStatus');
    statusEl.textContent = message;
    setTimeout(() => {
      if (statusEl.textContent === message) {
        statusEl.textContent = 'Synced';
      }
    }, 2000);
  }
  
  // Modified save function to use Supabase
  async function save(state) {
    if (!currentUser || !isInitialized) return;
    
    await Promise.all([
      saveGoals(),
      saveChecks(),
      saveTargets()
    ]);
  }
  
  // ------------------ Rest of your existing code ------------------
  const todayISO = () => {
    const d = new Date();
    const y = d.getFullYear();
    const m = String(d.getMonth()+1).padStart(2,'0');
    const day = String(d.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  };
  
  const startOfWeek = (d) => { const x=new Date(d); const day=(x.getDay()+6)%7; x.setDate(x.getDate()-day); x.setHours(0,0,0,0); return x }
  const startOfMonth = (d) => { const x=new Date(d); x.setDate(1); x.setHours(0,0,0,0); return x }
  const iso = (d) => {
    const x = new Date(d);
    const y = x.getFullYear();
    const m = String(x.getMonth()+1).padStart(2,'0');
    const day = String(x.getDate()).padStart(2,'0');
    return `${y}-${m}-${day}`;
  };

  function id(){ return Math.random().toString(36).slice(2,9) }

  // ------------------ DOM Helpers ------------------
  const $ = (sel) => document.querySelector(sel);
  function el(tag, attrs={}, kids=[]) {
    const e = document.createElement(tag);
    for (const [k,v] of Object.entries(attrs)) {
      if (k==='class') e.className=v; else if (k==='html') e.innerHTML=v; else e.setAttribute(k,v)
    }
    for (const kid of kids) e.append(kid);
    return e;
  }

  // ------------------ Rendering ------------------
  function render(){
    if (!isInitialized) return;
    renderToday();
    renderGoals();
    renderCalendar();
    renderTargets();
  }

  function renderTargets(){
    $('#weeklyTarget').value = state.weeklyTarget || 0;
    $('#monthlyTarget').value = state.monthlyTarget || 0;

    const weekStart = startOfWeek(new Date());
    const weekEnd = new Date(weekStart); weekEnd.setDate(weekEnd.getDate()+7);
    const monthStart = startOfMonth(new Date());
    const monthEnd = new Date(monthStart); monthEnd.setMonth(monthEnd.getMonth()+1);
    const weekPts = sumPointsBetween(weekStart, weekEnd);
    const monthPts = sumPointsBetween(monthStart, monthEnd);

    const wp = pct(weekPts, state.weeklyTarget||0);
    const mp = pct(monthPts, state.monthlyTarget||0);

    $('#weekProgress').style.width = wp + '%';
    $('#weekStats').textContent = `${weekPts} / ${state.weeklyTarget||0} pts`;

    $('#monthProgress').style.width = mp + '%';
    $('#monthStats').textContent = `${monthPts} / ${state.monthlyTarget||0} pts`;
  }

  function pct(val, total){ if(!total) return 0; return Math.min(100, Math.round((val/total)*100)); }

  function sumPointsBetween(start, end){
    let sum = 0;
    const s = new Date(start); const e = new Date(end);
    for (let d=new Date(s); d<e; d.setDate(d.getDate()+1)){
      sum += dayPoints(iso(d));
    }
    return sum;
  }

  function renderToday(){
    const tISO = todayISO();
    $('#todayLabel').textContent = new Date().toLocaleDateString(undefined, { weekday:'long', year:'numeric', month:'short', day:'numeric'});
    const wrap = $('#todayGoals'); wrap.innerHTML='';

    if(state.goals.length===0){
      wrap.append(el('div', {class:'goal'}, [el('div', {html:'No goals yet. Add one below!'})]));
      $('#todayProgress').style.width='0%';
      $('#todayStats').textContent='0 completed';
      return;
    }

    let done=0; const total = state.goals.length;
    for(const g of state.goals){
      const container = el('div', {class:'goal'});
      const left = el('div', {class:'left'});
      let isDone = false;

      if(g.mode === 'count'){
        const count = getDayValue(tISO, g.id) || 0;
        const pts = count * Number(g.points||1);
        isDone = count>0;
        const minus = el('button', {class:'btn', title:'decrease'}, [document.createTextNode('–')]);
        const plus = el('button', {class:'btn', title:'increase'}, [document.createTextNode('+')]);
        const counter = el('span', {class:'pill', html:`${count} unit${count===1?'':'s'} • ${pts} pts`});
        minus.addEventListener('click', ()=> { setCount(tISO, g.id, Math.max(0, (getDayValue(tISO,g.id)||0)-1)); });
        plus.addEventListener('click', ()=> { setCount(tISO, g.id, (getDayValue(tISO,g.id)||0)+1); });
        left.append(minus, plus);
        left.append(el('div', {html:`<strong>${escapeHtml(g.name)}</strong><br/><small class="pill">${g.points} pt / ${escapeHtml(g.unitLabel||'unit')}</small>`}));
        container.append(left);
        container.append(counter);
      } else {
        const checked = !!(state.checks[tISO]?.[g.id]);
        isDone = checked;
        const cb = el('input', {type:'checkbox', class:'checkbox'}); cb.checked = checked;
        cb.addEventListener('change', () => toggleCheck(tISO, g.id, cb.checked));
        left.append(cb);
        left.append(el('div', {html:`<strong>${escapeHtml(g.name)}</strong><br/><small class="pill">${g.points} pt${g.points==1?'':'s'}</small>`}));
        container.append(left);
        const del = el('button', {class:'btn danger'}, [document.createTextNode('Delete')]);
        del.addEventListener('click', ()=> removeGoal(g.id));
        container.append(del);
      }

      if(g.mode==='count'){
        const del = el('button', {class:'btn danger'}, [document.createTextNode('Delete')]);
        del.addEventListener('click', ()=> removeGoal(g.id));
        container.append(del);
      }

      wrap.append(container);
      if(isDone) done++;
    }

    const tpts = dayPoints(tISO);
    $('#todayProgress').style.width = Math.round((done/total)*100)+'%';
    $('#todayStats').textContent = `${done}/${total} goals • ${tpts} pts`;
  }

  function getDayValue(dayISO, gid){
    const day = state.checks[dayISO] || {}; const v = day[gid];
    if(typeof v === 'number') return v;
    if(v === true) return 1;
    return 0;
  }

  function dayPoints(dayISO){
    const day = state.checks[dayISO] || {}; let sum=0;
    for(const gid of Object.keys(day)){
      const g = state.goals.find(x=>x.id===gid); if(!g) continue;
      const v = day[gid];
      if(g.mode==='count') sum += (Number(g.points||1) * Number(v||0));
      else if(v) sum += Number(g.points||1);
    }
    return sum;
  }

  function renderGoals(){
    const list = $('#goalList'); list.innerHTML='';
    for(const g of state.goals){
      const row = el('div', {class:'goal'});
      const meta = g.mode==='count'
        ? `<span class="pill">${g.points} pt / ${escapeHtml(g.unitLabel||'unit')}</span>`
        : `<span class="pill">${g.points} pt${g.points==1?'':'s'}</span>`;
      row.append(el('div', {class:'left'}, [
        el('div', {html:`${meta}`}),
        el('div', {html:`<strong>${escapeHtml(g.name)}</strong>`})
      ]));
      const right = el('div', {class:'controls'});
      const up = el('button', {class:'btn'}, [document.createTextNode('▲')]);
      const down = el('button', {class:'btn'}, [document.createTextNode('▼')]);
      up.addEventListener('click', ()=> moveGoal(g.id, -1));
      down.addEventListener('click', ()=> moveGoal(g.id, +1));
      const edit = el('button', {class:'btn'}, [document.createTextNode('Edit')]);
      edit.addEventListener('click', ()=> editGoal(g.id));
      const del = el('button', {class:'btn danger'}, [document.createTextNode('Delete')]);
      del.addEventListener('click', ()=> removeGoal(g.id));
      right.append(up, down, edit, del);
      row.append(right);
      list.append(row);
    }
  }

  // ------------------ Calendar ------------------
  let currentMonth = new Date();
  function renderCalendar(){
    const cal = $('#calendar'); cal.innerHTML='';
    const year = currentMonth.getFullYear(); const month = currentMonth.getMonth();
    $('#monthLabel').textContent = currentMonth.toLocaleDateString(undefined, {month:'long', year:'numeric'});
    const first = new Date(year, month, 1);
    const start = new Date(first); const offset = (start.getDay()+6)%7; start.setDate(1 - offset);
    for(let i=0;i<42;i++){
      const d = new Date(start); d.setDate(start.getDate()+i);
      const isCurr = d.getMonth()===month;
      const node = el('div', {class:'day'+(isCurr?'':' empty')});
      const dISO = iso(d);
      const pts = dayPoints(dISO);
      const tag = el('span', {class:'tag', html: `${pts} pts`});
      const header = el('div', {class:'d', html: d.getDate()});
      if(iso(new Date())===dISO) node.classList.add('today');
      node.append(header, tag);
      node.addEventListener('click', ()=> openDayEditor(dISO));
      cal.append(node);
    }
  }

  function openDayEditor(dISO){
    const name = (function(){ const [y,m,dd]=dISO.split('-').map(n=>parseInt(n,10)); return new Date(y, m-1, dd).toLocaleDateString(undefined, { weekday:'long', year:'numeric', month:'short', day:'numeric'}); })();
    const existing = state.checks[dISO] || {};
    const checks = state.goals.map(g=>{
      if(g.mode==='count'){
        const val = Number(existing[g.id]||0);
        return `<label style="display:flex;align-items:center;gap:8px;margin:6px 0">
          <input type="number" min="0" step="1" data-gid="${g.id}" value="${val}" class="input" style="width:90px"/>
          ${escapeHtml(g.name)} <span class="pill">${g.points} pt / ${escapeHtml(g.unitLabel||'unit')}</span>
        </label>`
      } else {
        const checked = !!existing[g.id];
        return `<label style="display:flex;align-items:center;gap:8px;margin:6px 0">
          <input type="checkbox" data-gid="${g.id}" ${checked?'checked':''}/> ${escapeHtml(g.name)} <span class="pill">${g.points} pts</span>
        </label>`
      }
    }).join('');
    const html = `<div style="display:flex;flex-direction:column;gap:8px">
      <div><strong>${name}</strong></div>
      ${checks || '<small>No goals yet.</small>'}
    </div>`;
    dialog(html, {
      onConfirm: ()=>{
        const inputs = Array.from(document.querySelectorAll('dialog [data-gid]'));
        const day = {};
        inputs.forEach(i=>{
          const gid=i.dataset.gid;
          if(i.type==='checkbox') day[gid] = i.checked;
          else day[gid] = Math.max(0, parseInt(i.value||'0',10)||0);
        });
        if(Object.keys(day).length>0){ state.checks[dISO]=day } else { delete state.checks[dISO] }
        save(state); render();
      }
    });
  }

  // ------------------ Actions ------------------
  function toggleCheck(dayISO, gid, val){
    state.checks[dayISO] = state.checks[dayISO] || {};
    state.checks[dayISO][gid] = !!val;
    if(state.checks[dayISO] && Object.keys(state.checks[dayISO]).every(k=>!state.checks[dayISO][k])) delete state.checks[dayISO];
    save(state); renderTargets(); renderToday(); renderCalendar();
  }

  function setCount(dayISO, gid, count){
    state.checks[dayISO] = state.checks[dayISO] || {};
    state.checks[dayISO][gid] = Math.max(0, Math.floor(Number(count)||0));
    if(state.checks[dayISO] && Object.keys(state.checks[dayISO]).every(k=> state.checks[dayISO][k]===false || state.checks[dayISO][k]===0)) delete state.checks[dayISO];
    save(state); renderTargets(); renderToday(); renderCalendar();
  }

  function removeGoal(gid){
    if(!confirm('Delete this goal?')) return;
    state.goals = state.goals.filter(g=>g.id!==gid);
    for(const k of Object.keys(state.checks)){
      if(state.checks[k] && (gid in state.checks[k])){
        delete state.checks[k][gid];
        if(Object.keys(state.checks[k]).length===0) delete state.checks[k];
      }
    }
    save(state); render();
  }

  function moveGoal(gid, dir){
    const i = state.goals.findIndex(g=>g.id===gid); if(i<0) return;
    const j = Math.max(0, Math.min(state.goals.length-1, i+dir));
    if(i===j) return; const tmp = state.goals[i]; state.goals[i]=state.goals[j]; state.goals[j]=tmp; save(state); render();
  }

  function editGoal(gid){
    const g = state.goals.find(x=>x.id===gid); if(!g) return;
    const html = `<div style="display:flex;flex-direction:column;gap:8px">
      <label>Name <input id="egName" class="input" value="${escapeHtml(g.name)}"/></label>
      <label>Mode
        <select id="egMode" class="input">
          <option value="binary" ${g.mode==='binary'?'selected':''}>Binary (check/unchecked)</option>
          <option value="count" ${g.mode==='count'?'selected':''}>Count (units per day)</option>
        </select>
      </label>
      <label>Points <input id="egPts" class="input" type="number" min="1" value="${g.points}"/></label>
      <div id="egCountFields" style="display:${g.mode==='count'?'block':'none'}">
        <label>Unit label <input id="egUnitLabel" class="input" value="${escapeHtml(g.unitLabel||'unit')}" placeholder="e.g., 5k steps"/></label>
        <label>Unit size <input id="egUnitSize" class="input" type="number" min="1" value="${g.unitSize||1}"/></label>
        <small>Each unit gives the Points above. Example: 1 pt per \"5k steps\".</small>
      </div>
    </div>`;
    dialog(html, {
      onConfirm: ()=>{
        const name = document.getElementById('egName').value.trim();
        const mode = document.getElementById('egMode').value;
        const pts = Number(document.getElementById('egPts').value || 1);
        const unitLabel = (document.getElementById('egUnitLabel')?.value||'unit').trim();
        const unitSize = Number(document.getElementById('egUnitSize')?.value||1);
        if(name) { Object.assign(g, {name, mode, points:pts, unitLabel, unitSize}); save(state); render(); }
      }
    });
    setTimeout(()=>{
      const modeSel = document.getElementById('egMode');
      modeSel?.addEventListener('change', ()=>{
        document.getElementById('egCountFields').style.display = modeSel.value==='count' ? 'block' : 'none';
      });
    },0);
  }

  function addGoal(name, points){
    name = (name||'').trim(); points = Number(points||1);
    const mode = (document.getElementById('goalMode')?.value)||'binary';
    const unitLabel = (document.getElementById('goalUnitLabel')?.value||'unit').trim();
    const unitSize = Number(document.getElementById('goalUnitSize')?.value||1);
    if(!name) return alert('Please enter a goal name.');
    const goal = {id:id(), name, points, mode};
    if(mode==='count') Object.assign(goal, {unitLabel, unitSize});
    state.goals.push(goal); save(state); render();
    $('#goalName').value=''; $('#goalPoints').value='1';
  }

  function quickAdd(){
    dialog(`<div style="display:flex;flex-direction:column;gap:8px">
      <label>Goal name <input id="qaName" class="input" placeholder="e.g., Stretch 10 min"/></label>
      <label>Mode
        <select id="qaMode" class="input">
          <option value="binary">Binary (check/unchecked)</option>
          <option value="count">Count (units per day)</option>
        </select>
      </label>
      <label>Points <input id="qaPts" class="input" type="number" value="1" min="1"/></label>
      <div id="qaCountFields" style="display:none">
        <label>Unit label <input id="qaUnitLabel" class="input" placeholder="e.g., 5k steps"/></label>
        <label>Unit size <input id="qaUnitSize" class="input" type="number" value="1" min="1"/></label>
      </div>
      <small>Tip: For steps like yours, set Mode=Count, Unit label=\"5k steps\", Unit size=5000, Points=1.</small>
    </div>`, { onConfirm: ()=>{
      const mode = (document.getElementById('qaMode').value);
      const name = $('#qaName').value; const pts = $('#qaPts').value;
      if(mode==='count'){
        const ul = $('#qaUnitLabel').value||'unit'; const us = Number($('#qaUnitSize').value||1);
        state.goals.push({id:id(), name, points:Number(pts||1), mode, unitLabel:ul, unitSize:us});
      } else {
        state.goals.push({id:id(), name, points:Number(pts||1), mode});
      }
      save(state); render();
    }});
    setTimeout(()=>{
      const sel = document.getElementById('qaMode');
      const block = document.getElementById('qaCountFields');
      sel.addEventListener('change', ()=>{ block.style.display = sel.value==='count' ? 'block' : 'none'; });
    },0);
  }

  function saveTargets(){
    state.weeklyTarget = Number($('#weeklyTarget').value||0);
    state.monthlyTarget = Number($('#monthlyTarget').value||0);
    save(state); renderTargets();
  }

  // ------------------ Export / Import / Reset ------------------
  function exportData(){
    const blob = new Blob([JSON.stringify(state, null, 2)], {type:'application/json'});
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = `checkit-backup-${todayISO()}.json`;
    document.body.appendChild(a); a.click(); a.remove();
  }
  
  function importData(file){
    const reader = new FileReader(); reader.onload = (e)=>{
      try{ const incoming = JSON.parse(e.target.result);
        if(!incoming || !incoming.goals || !('checks' in incoming)) throw new Error('Invalid file');
        incoming.goals = (incoming.goals||[]).map(g=> ({ mode:'binary', unitLabel:'', unitSize:1, ...g }));
        state = incoming; save(state); render(); alert('Import successful!');
      }catch(err){ alert('Import failed: '+err.message) }
    }; reader.readAsText(file);
  }
  
  function clearAll(){ 
    if(confirm('This will erase all data. Continue?')) { 
      state = { ...defaultState }; 
      save(state); 
      render(); 
    } 
  }

  // ------------------ Dialog ------------------
  function dialog(innerHTML, {onConfirm}={}){
    const d = document.createElement('dialog');
    d.style.border='1px solid #29405e'; d.style.background='#0b1220'; d.style.color='var(--text)'; d.style.borderRadius='14px'; d.style.padding='14px'; d.style.maxWidth='520px';
    d.innerHTML = `<div style="display:flex;flex-direction:column;gap:10px">${innerHTML}
      <div style="display:flex;gap:8px;justify-content:flex-end"><button class="btn" id="dlgCancel">Cancel</button><button class="btn primary" id="dlgOk">Save</button></div>
    </div>`;
    document.body.append(d); if(d.showModal) d.showModal(); else d.show();
    d.querySelector('#dlgCancel').addEventListener('click', ()=>{ d.close && d.close(); d.remove(); });
    d.querySelector('#dlgOk').addEventListener('click', ()=>{ onConfirm && onConfirm(); d.close && d.close(); d.remove(); });
  }

  // ------------------ Utils ------------------
  function escapeHtml(s){ return (s||'').toString().replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])) }

  // ------------------ Events ------------------
  document.getElementById('signInBtn').addEventListener('click', signIn);
  document.getElementById('signUpBtn').addEventListener('click', signUp);
  document.getElementById('btnSignOut').addEventListener('click', signOut);
  document.getElementById('btnAddGoal').addEventListener('click', ()=> addGoal($('#goalName').value, $('#goalPoints').value));
  document.getElementById('btnSaveTargets').addEventListener('click', saveTargets);
  document.getElementById('btnExport').addEventListener('click', exportData);
  document.getElementById('importFile').addEventListener('change', (e)=> e.target.files[0] && importData(e.target.files[0]));
  document.getElementById('btnClear').addEventListener('click', clearAll);
  document.getElementById('prevMonth').addEventListener('click', ()=>{ currentMonth.setMonth(currentMonth.getMonth()-1); renderCalendar(); });
  document.getElementById('nextMonth').addEventListener('click', ()=>{ currentMonth.setMonth(currentMonth.getMonth()+1); renderCalendar(); });

  // show/hide unit fields based on mode
  (function(){
    const sel = document.getElementById('goalMode');
    const ul = document.getElementById('goalUnitLabel');
    const us = document.getElementById('goalUnitSize');
    function toggle(){ const show = sel.value==='count'; ul.style.display = show?'block':'none'; us.style.display = show?'block':'none'; }
    sel.addEventListener('change', toggle); toggle();
  })();

  // ------------------ Init ------------------
  initAuth();
</script>
</body>
</html>
